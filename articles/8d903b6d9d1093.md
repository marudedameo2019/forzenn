---
title: "unionメンバを持つstruct(class)の扱い"
emoji: "🍣"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["cpp"]
published: true
---

# 序

この記事は以前Qiitaに掲載していたモノ(BANされたので今は削除されている)を少し手直ししたものです。
Zennに関連記事を書くかもしれないので引っ張ってきました。

----

表題の件、意外に難しい。Cの頃から`union`と言えば…

https://github.com/marudedameo2019/struct_with_union/blob/2dcf71aa90a18876ac92db03f2a7f3194500a5e3/hoge.cpp

こんな風にメモリ上のアラインメントを見るのに使ったりするくらいで、あまり出番がないと思っていました。しかし、C++23で追加になった`std::expected`が今回rustの`Result`もどきらしく、それをC++11で簡易実装しようとしたら`union`が必要になったのです。

で、結構ハマりました。

# 1. std::expectedとは

https://cpprefjp.github.io/reference/expected/expected.html

ようは戻り値で結果とエラーを同時に返すやつです。最近の言語には例外がなく、人によっては`null`と同様に親の仇のごとく敵視されていると思います。なので、結果とエラーを同時に扱う型が重宝され、Cみたいにチマチマ条件分岐したり、エラーとセットでストリーム処理したりします。その型がRustの`Result`/`Option`だったり、`std::expected`(c++23)/`std::optional`(c++17)だったりするわけです。

# 2. なぜunionが必要なのか？

結果とエラーを同時に扱うわけですが、結果とエラーは同時に存在しません。別々にメモリ確保してもいいけど、それは勿体ないというわけで`union`の出番となるわけです(C++17には`std::variant`がありますが、C++11にはありません)。

最初に作ったのは以下のコードで、こんな感じに`union`を使いたかったわけです。

https://github.com/marudedameo2019/struct_with_union/blob/0b98b0a2f80c5d138f8b0428cef32c0ebd403e75/div.cpp

しかしこれはエラーになります。

# 3. なぜエラーになったのか？

`union`はデフォルトコンストラクタが自動作成されないからです。

```shell-session
div.cpp: In function 'result<double, std::__cxx11::basic_string<char> > idiv(int, int)':
div.cpp:16:28: error: use of deleted function 'result<double, std::__cxx11::basic_string<char> >::result()'
   16 |     result<double, string> r;
      |                            ^
div.cpp:5:8: note: 'result<double, std::__cxx11::basic_string<char> >::result()' is implicitly deleted because the default definition would be ill-formed:
    5 | struct result {
      |        ^~~~~~
```

最初に書いたprimitiveな`union`は良かったのですが、`union`のメンバにコンストラクタを持つオブジェクトなどが入ってくると、デフォルトのコンストラクタは`union`内のどのメンバのコンストラクタを呼ぶ必要があるのか分かりません。どれか1つしか呼んではいけないのだから。

# 4. `union`にコンストラクタを作る

なので、まずは`union`にコンストラクタを作り、それを呼び出すためのコンストラクタを`result`側にも用意します。

https://github.com/marudedameo2019/struct_with_union/blob/fd7a3b090a8d4d2e1e6182a14619123e9aad847c/div.cpp

これで動くかなと思いきや、まだエラーが出ます。

```shell-session
div.cpp: In function 'result<double, std::__cxx11::basic_string<char> > idiv(int, int)':
div.cpp:20:29: error: use of deleted function 'result<double, std::__cxx11::basic_string<char> >::~result()'
   20 |     if (right == 0) {return string("cannot divide by 0");} // 変更
      |                             ^~~~~~~~~~~~~~~~~~~~~~~~~~~~
div.cpp:5:8: note: 'result<double, std::__cxx11::basic_string<char> >::~result()' is implicitly deleted because the default definition would be ill-formed:
    5 | struct result {
      |        ^~~~~~
```

今度はデフォルトのデストラクタがないと怒られています。そうなのです。`union`にはデフォルトのデストラクタがないので、それをaggregateしている`result`にもデフォルトのデストラクタがないわけです。

# 5. `union`の外からデストラクタを呼ぶ

というわけで、`union`内にはハリボテの空デストラクタを用意し、`result`のデストラクタで`union`内のメンバデストラクタを直接呼び出します。`union`自身にはどのメンバで構築されてるかの情報がないので。

https://github.com/marudedameo2019/struct_with_union/blob/d450d7e569afd7e67bbc5a0b921dffae90636fae/div.cpp

しかしコンパイルするとこれでもエラーになります。

```shell-session
div.cpp: In function 'result<double, std::__cxx11::basic_string<char> > idiv(int, int)':
div.cpp:25:29: error: use of deleted function 'result<double, std::__cxx11::basic_string<char> >::result(const result<double, std::__cxx11::basic_string<char> >&)'
   25 |     if (right == 0) {return string("cannot divide by 0");}
      |                             ^~~~~~~~~~~~~~~~~~~~~~~~~~~~
div.cpp:5:8: note: 'result<double, std::__cxx11::basic_string<char> >::result(const result<double, std::__cxx11::basic_string<char> >&)' is implicitly deleted because the default definition would be ill-formed:
    5 | struct result {
      |        ^~~~~~
```

今度は`result`のコピーコンストラクタがないと怒られています。戻り値で一時オブジェクトを構築するわけですが、それを呼び出し側の変数にコピーできないということです。これは例によって`union`のためにコピーコンストラクタも自動では生成されないことが原因です。

# 6. コピーコンストラクタ定義とplacement new

コピーコンストラクタを定義するわけですが、このコピーが一筋縄では出来ません。オリジナルのメンバ変数によって`union`のメンバイニシャライザ呼び出しを切り替えられないため、メンバイニシャライザを使えないからです。なので以下のようにします。

https://github.com/marudedameo2019/struct_with_union/blob/baa75975e4ccb7e18cda4d0538e2500c5263ec93/div.cpp

ついに`union`に空のデフォルトコンストラクタが入っています。これはメンバイニシャライザが使えないので、どうしても必要になるものです。デフォルトデストラクタもそうなのですが、両方必要悪なのです。

これはようやく動いて

```shell-session
0.333333
```

となります。めでたしめでたし。

# 7. まとめ

`class`/`struct`にprimitiveでない`union`メンバを入れるとデフォルトコンストラクタなどが消えて結構大変！

- `union`にデフォルトコンストラクタがない
 → `union`に引数付きのコンストラクタを用意する
- `union`にデフォルトデストラクタがない
 → `union`の外から`union`のデストラクタを直に呼び出す
- `union`にコピーコンストラクタがない
 → `union`の外のコピーコンストラクタからplacement new

----
# 参考リンク

https://ja.cppreference.com/w/cpp/language/union