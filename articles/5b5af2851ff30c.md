---
title: "ä»®æƒ³é–¢æ•°ã¨æœ€é©åŒ–ã«ã¤ã„ã¦"
emoji: "ğŸ¡"
type: "tech"
topics:
  - "cpp"
  - "linux"
  - "gcc"
published: true
published_at: "2025-02-26 04:16"
---

# åº

ä»®æƒ³é–¢æ•°ã£ã¦å®Ÿéš›ã©ã†ãªã‚‹ã®ï¼Ÿ
ã£ã¦ã„ã†è©±ã¨ã€

æœ€é©åŒ–(ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³å±•é–‹)ã¯ã©ã“ã¾ã§æœ‰åŠ¹ãªã®ï¼Ÿ
ã¨ã„ã†è©±ã‚’gccã§ç°¡å˜ã«æ¤œè¨¼ã—ã¦ã¿ã¾ã—ãŸã€‚

â€»å…ƒã¯4æ—¥ã»ã©å‰ã«Qiitaã«è¼‰ã›ãŸè¨˜äº‹ã§ã™ãŒã€ç·¨é›†ä¸å¯èƒ½ã«ãªã£ã¦ã—ã¾ã£ãŸã®ã§(å°†æ¥çš„ã«ã¯å‰Šé™¤äºˆå®š)ã€ã“ã¡ã‚‰ã«å¼•ã£è¶Šã—ã¦ã„ã¾ã™ã€‚

# 1. å‰æ

## 1-1. å¯¾è±¡èª­è€…

- [ä»®æƒ³é–¢æ•°ãƒ†ãƒ¼ãƒ–ãƒ«](https://ja.wikipedia.org/wiki/%E4%BB%AE%E6%83%B3%E9%96%A2%E6%95%B0%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB)ã¨ã„ã†è¨€è‘‰ã‚’ä½•ã¨ãªãçŸ¥ã£ã¦ã„ã‚‹äºº
- x86_amd64ã‚¢ã‚»ãƒ³ãƒ–ãƒ©ã‚’èª­ã‚ã‚‹äºº(ä»Šå›ã¯intelã«ã—ã¦ã¿ãŸã€‚æ™®æ®µã¯AT&T)
- ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³å±•é–‹ã‚’çŸ¥ã£ã¦ã„ã‚‹äºº
- Linuxã¨GNUã®ãƒ„ãƒ¼ãƒ«ã‚’ä½¿ã£ã¦ã‚‹äºº

â€»ãªã®ã§ç´°ã‹ã„èª¬æ˜ã¯çœç•¥ã—ã¦ã„ã¾ã™

## 1-2. æ¤œè¨¼ç’°å¢ƒ

- Ubuntu 24.04
- gcc 13

# 2. æ¤œè¨¼

ç°¡å˜ãªã‚µãƒ³ãƒ—ãƒ«ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’ç”¨æ„ã—ã€ãã‚Œã‚’ãƒ“ãƒ«ãƒ‰ã—ã¦ãƒã‚¤ãƒŠãƒªã‚’ãƒ€ãƒ³ãƒ—ã—ã¦ç¢ºèªã—ã¾ã™ã€‚

## 2-1. ã‚µãƒ³ãƒ—ãƒ«1

:::details æ¤œè¨¼ã‚¹ã‚¯ãƒªãƒ—ãƒˆå…¨ä½“

```sh:sample1.sh
cat >sample1.cpp <<EOF
class cls_base {
public:
    virtual int method() = 0;
    virtual int method2() = 0;
};
class cls_sub1: public cls_base {
public:
    int method() {return 2;}
    int method2() {return 5;}
};
class cls_sub2: public cls_base {
public:
    int method() {return 3;}
    int method2() {return 6;}
};
int main() {
    cls_sub2 o;
    cls_base* po = &o;
    return po->method() + po->method2();
}
EOF
g++ -g -Wall -pedantic sample1.cpp -o sample1
objdump -M intel -StC sample1
```
:::

```cpp:sample1.cpp
class cls_base {
public:
    virtual int method() = 0;
    virtual int method2() = 0;
};
class cls_sub1: public cls_base {
public:
    int method() {return 2;}
    int method2() {return 5;}
};
class cls_sub2: public cls_base {
public:
    int method() {return 3;}
    int method2() {return 6;}
};
int main() {
    cls_sub2 o;
    cls_base* po = &o;
    return po->method() + po->method2();
}
```
ã“ã‚Œã‚’æœ€é©åŒ–ã›ãšã«ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«/ãƒªãƒ³ã‚¯ã—ã€objdumpã—ãŸçµæœã®ã†ã¡ã€ä»®æƒ³é–¢æ•°å‘¼ã³å‡ºã—éƒ¨åˆ†ãŒä»¥ä¸‹ã«ãªã‚Šã¾ã™ã€‚
```nasm
...
    return po->method() + po->method2();
    1178:	48 8b 45 e0          	mov    rax,QWORD PTR [rbp-0x20]
    117c:	48 8b 00             	mov    rax,QWORD PTR [rax]
    117f:	48 8b 10             	mov    rdx,QWORD PTR [rax]
    1182:	48 8b 45 e0          	mov    rax,QWORD PTR [rbp-0x20]
    1186:	48 89 c7             	mov    rdi,rax
    1189:	ff d2                	call   rdx
    118b:	89 c3                	mov    ebx,eax
    118d:	48 8b 45 e0          	mov    rax,QWORD PTR [rbp-0x20]
    1191:	48 8b 00             	mov    rax,QWORD PTR [rax]
    1194:	48 83 c0 08          	add    rax,0x8
    1198:	48 8b 10             	mov    rdx,QWORD PTR [rax]
    119b:	48 8b 45 e0          	mov    rax,QWORD PTR [rbp-0x20]
    119f:	48 89 c7             	mov    rdi,rax
    11a2:	ff d2                	call   rdx
    11a4:	01 d8                	add    eax,ebx
}
...
```

`rbp-0x20`ãŒ`po`ã§ã™ã€‚`po`ã®å€¤ã‚’å–ã‚Šå‡ºã—ã€æœ€åˆã®8ãƒã‚¤ãƒˆã‚’å–ã£ã¦ãã¦ã„ã¾ã™ãŒã€ãã“ãŒã€Œ`po`ãŒæŒ‡ã™ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã€ã®**ä»®æƒ³é–¢æ•°ãƒ†ãƒ¼ãƒ–ãƒ«**ã«ãªã‚Šã¾ã™ã€‚ã“ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã®æœ€åˆã®8ãƒã‚¤ãƒˆãŒ`method()`ã§ã€æ¬¡ã®8ãƒã‚¤ãƒˆãŒ`method2()`ã§ã™(ã“ã®é †åºã¯`cls_sub1`ã§ã‚‚`cls_sub2`ã§ã‚‚åŒã˜ã§ã™)ã€‚æœ€åˆã«å‘¼ã¶ã®ã¯`method()`ãªã®ã§ã€å–ã£ã¦ããŸã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ãã®ã¾ã¾å‚ç…§ã—ã€rdxãƒ¬ã‚¸ã‚¹ã‚¿ã«å…¥ã‚Œã¦callã™ã‚‹ã“ã¨ã§ä»®æƒ³é–¢æ•°å‘¼ã³å‡ºã—ã‚’ã—ã¦ã„ã¾ã™ã€‚
ãªãŠ`po`ã®å‚ç…§å…ˆã®æœ€åˆã®8ãƒã‚¤ãƒˆã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯ã€å‚ç…§å…ˆã§ã‚ã‚‹`o`ãŒç”Ÿæˆã•ã‚ŒãŸã¨ãã«æ›¸ãè¾¼ã¾ã‚Œã¦ã„ã¾ã™ã€‚

```nasm
    cls_sub2 o;
    1165:	48 8d 05 14 2c 00 00 	lea    rax,[rip+0x2c14]        # 3d80 <vtable for cls_sub2+0x10>
    116c:	48 89 45 d8          	mov    QWORD PTR [rbp-0x28],rax
```

### 2-1-1. (ä½™è«‡)ä»®æƒ³é–¢æ•°ãƒ†ãƒ¼ãƒ–ãƒ«ã®èª¿ã¹æ–¹

#### 2-1-1-1. gccã«å‡ºåŠ›ã•ã›ã‚‹

gccã«`-fdump-lang-class`ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä»˜ã‘ã‚‹ã¨[ã‚½ãƒ¼ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«].[ã‚¯ãƒ©ã‚¹è­˜åˆ¥å­].classã®ã‚ˆã†ãªåå‰ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒç”Ÿæˆã•ã‚Œã€ãã“ã«ä»®æƒ³é–¢æ•°ãƒ†ãƒ¼ãƒ–ãƒ«ã«é–¢ã™ã‚‹æƒ…å ±ãŒå‡ºåŠ›ã•ã‚Œã¾ã™ã€‚

```shell-session
$ g++ -fdump-lang-class -g -Wall -pedantic sample1.cpp -o sample1
$ cat sample1.cpp.001l.class
Vtable for cls_base
cls_base::_ZTV8cls_base: 4 entries
0     (int (*)(...))0
8     (int (*)(...))(& _ZTI8cls_base)
16    (int (*)(...))__cxa_pure_virtual
24    (int (*)(...))__cxa_pure_virtual
...
```

https://gcc.gnu.org/onlinedocs/gcc/Developer-Options.html

ãŸã ã—ã€å®Ÿéš›ã«ã¯ã‚·ãƒ³ãƒœãƒ«ç”Ÿæˆã•ã‚Œã¦ãªã„ã‚‚ã®ã‚‚è§£æçµæœã¨ã—ã¦å‡ºåŠ›ã•ã‚Œã¦ã„ã‚‹ã®ã§æ³¨æ„ã—ã¦ä¸‹ã•ã„ã€‚åŸå‰‡ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–ã•ã‚Œã‚‹ãªã©ã€å¿…è¦ã«ãªã‚‰ãªã„ã¨ç”Ÿæˆã•ã‚Œã¾ã›ã‚“ã€‚

#### 2-1-1-2. gdbã§å®Ÿè¡Œæ™‚ã«èª¿ã¹ã‚‹

gdbã«`info vtbl å¤‰æ•°å`ãªã©ã—ã¦ã‚ã’ã‚Œã°å‡ºã¦ãã¾ã™ã€‚

```shell-session
Breakpoint 1, main () at sample1.cpp:16
16	int main() {
(gdb) n
17	    cls_sub2 o;
(gdb) n
18	    cls_base* po = &o;
(gdb) n
19	    return po->method() + po->method2();
(gdb) info vtbl po
vtable for 'cls_base' @ 0x555555557d80 (subobject @ 0x7fffffffdd38):
[0]: 0x5555555551c0 <cls_sub2::method()>
[1]: 0x5555555551d4 <cls_sub2::method2()>
(gdb) 
```

è©³ç´°ã¯ä»¥ä¸‹ã€‚

https://sourceware.org/gdb/current/onlinedocs/gdb.html/Debugging-C-Plus-Plus.html

## 2-2. ã‚µãƒ³ãƒ—ãƒ«2

ã‚µãƒ³ãƒ—ãƒ«1ã‚’`-O3`ã§æœ€é©åŒ–ã—ã¦ã¿ã¾ã™(å€‹äººçš„ãªæ„Ÿè¦šã§ã¯ã€ã‚ˆãã‚ã‚‹æœ€é©åŒ–ã¯`-O2`ã§ã™)ã€‚ä»¥ä¸‹ã¯ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å·®åˆ†ã®ã¿ã§ã™ã€‚

```diff sh
--- sample1.sh	2025-02-22 16:58:10.421276062 +0900
@@ -1,4 +1,4 @@
-cat >sample1.cpp <<EOF
+cat >sample2.cpp <<EOF
 class cls_base {
 public:
     virtual int method() = 0;
@@ -20,5 +20,5 @@ int main() {
     return po->method() + po->method2();
 }
 EOF
-g++ -g -Wall -pedantic sample1.cpp -o sample1
-objdump -M intel -StC sample1
+g++ -O3 -g -Wall -pedantic sample2.cpp -o sample2
+objdump -M intel -StC sample2
```

çµæœã¯ã€main()ãŒã“ã†ãªã‚Šã¾ã™ã€‚

```shell-session
...
0000000000001040 <main>:
class cls_sub2: public cls_base {
public:
    int method() {return 3;}
    int method2() {return 6;}
};
int main() {
    1040:	f3 0f 1e fa          	endbr64
    cls_sub2 o;
    cls_base* po = &o;
    return po->method() + po->method2();
}
    1044:	b8 09 00 00 00       	mov    eax,0x9
    1049:	c3                   	ret
    104a:	66 0f 1f 44 00 00    	nop    WORD PTR [rax+rax*1+0x0]
...
```

ä»®æƒ³é–¢æ•°å‘¼ã³å‡ºã—ãŒã‚ã£ãŸã¨ã—ã¦ã‚‚ã€ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒåˆ†ã‹ã£ã¦ã„ã¦ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³å±•é–‹å¯èƒ½ã§ã‚ã‚Œã°å±•é–‹ã•ã‚Œã¦æœ€é©åŒ–ã•ã‚ŒãŸã‚ˆã†ãªçµæœ(ç›´å€¤)ã«ãªã£ã¦ã„ã¾ã™ã€‚

## 2-3. ã‚µãƒ³ãƒ—ãƒ«3

æ¬¡ã¯ã‚µãƒ³ãƒ—ãƒ«2ã‚’ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«åˆ†å‰²ã—ã¦ã¿ã¾ã™ã€‚

```diff sh
--- sample2.sh	2025-02-22 17:07:01.199038214 +0900
@@ -1,4 +1,5 @@
-cat >sample2.cpp <<EOF
+cat >sample3.h <<EOF
+#pragma once
 class cls_base {
 public:
     virtual int method() = 0;
@@ -14,11 +15,26 @@ public:
     int method() {return 3;}
     int method2() {return 6;}
 };
+class factory {
+public:
+    cls_base* create();
+};
+EOF
+cat >sample3.cpp <<EOF
+#include "sample3.h"
 int main() {
-    cls_sub2 o;
-    cls_base* po = &o;
+    factory f;
+    cls_base* po = f.create();
     return po->method() + po->method2();
 }
 EOF
-g++ -O3 -g -Wall -pedantic sample2.cpp -o sample2
-objdump -M intel -StC sample2
+cat >sample3_factory.cpp <<EOF
+#include "sample3.h"
+cls_base* factory::create() {
+    static cls_sub2 o;
+    return &o;
+}
+EOF
+g++ -c -O3 -g -Wall -pedantic sample3_factory.cpp
+g++ -O3 -g -Wall -pedantic sample3.cpp sample3_factory.o -o sample3
+objdump -M intel -StC sample3
```

çµæœã¯ã“ã†ãªã‚Šã¾ã™ã€‚

```nasm
    return po->method() + po->method2();
    1087:	48 8b 00             	mov    rax,QWORD PTR [rax]
    108a:	48 89 df             	mov    rdi,rbx
    108d:	ff 10                	call   QWORD PTR [rax]
    108f:	48 89 df             	mov    rdi,rbx
    1092:	89 c5                	mov    ebp,eax
    1094:	48 8b 03             	mov    rax,QWORD PTR [rbx]
    1097:	ff 50 08             	call   QWORD PTR [rax+0x8]
    109a:	01 e8                	add    eax,ebp
}
```

ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒåˆ†ã‹ã‚‰ãªã„ã®ã ã‹ã‚‰å½“ãŸã‚Šå‰ã§ã™ã‚ˆã­ã€‚

## 2-4. ã‚µãƒ³ãƒ—ãƒ«4

æ¬¡ã¯ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«åˆ†å‰²ã—ã¤ã¤ã‚‚ãƒªãƒ³ã‚¯æ™‚æœ€é©åŒ–ã‚’å…¥ã‚Œã¾ã™(å€‹äººçš„ãªæ„Ÿè¦šã§ã¯ã€ã‚ˆãã‚ã‚‹æœ€é©åŒ–ã ã¨ãƒªãƒ³ã‚¯æ™‚æœ€é©åŒ–ã¯è¡Œã‚ã‚Œã¾ã›ã‚“)ã€‚

```diff sh
--- sample3.sh	2025-02-22 17:24:58.867204941 +0900
@@ -1,4 +1,4 @@
-cat >sample3.h <<EOF
+cat >sample4.h <<EOF
 #pragma once
 class cls_base {
 public:
@@ -20,21 +20,21 @@ public:
     cls_base* create();
 };
 EOF
-cat >sample3.cpp <<EOF
-#include "sample3.h"
+cat >sample4.cpp <<EOF
+#include "sample4.h"
 int main() {
     factory f;
     cls_base* po = f.create();
     return po->method() + po->method2();
 }
 EOF
-cat >sample3_factory.cpp <<EOF
-#include "sample3.h"
+cat >sample4_factory.cpp <<EOF
+#include "sample4.h"
 cls_base* factory::create() {
     static cls_sub2 o;
     return &o;
 }
 EOF
-g++ -c -O3 -g -Wall -pedantic sample3_factory.cpp
-g++ -O3 -g -Wall -pedantic sample3.cpp sample3_factory.o -o sample3
-objdump -M intel -StC sample3
+g++ -c -flto -O3 -g -Wall -pedantic sample4_factory.cpp
+g++ -flto -O3 -g -Wall -pedantic sample4.cpp sample4_factory.o -o sample4
+objdump -M intel -StC sample4
```

ã“ã‚Œã§å…ƒã«æˆ»ã‚‹ã‹ã¨æ€ã„ãã‚„â€¦

```nasm
...
    return po->method() + po->method2();
    1044:	48 8d 3d c5 2f 00 00 	lea    rdi,[rip+0x2fc5]        # 4010 <factory::create()::o>
    104b:	e8 00 01 00 00       	call   1150 <cls_sub2::method()>
    1050:	89 c2                	mov    edx,eax
    1052:	e8 09 01 00 00       	call   1160 <cls_sub2::method2()>
    1057:	01 d0                	add    eax,edx
}
...
```

ä¸­é€”åŠç«¯ã«æ®‹ã£ã¦ã—ã¾ã£ã¦ã„ã¾ã™ã€‚ã—ã‹ã—è¦‹ã‚‹ã‹ã‚‰ã«ä»®æƒ³é–¢æ•°å‘¼ã³å‡ºã—ã«ã¯ãªã£ã¦ã„ã¾ã›ã‚“ã€‚ã“ã®è¾ºãŒç¾çŠ¶ã®gccã®é™ç•Œãªã®ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚

## (ãŠã¾ã‘)ã‚µãƒ³ãƒ—ãƒ«5

gcc-14ã«ã—ã¦ã¿ã¾ã—ãŸ(apt install g++-14)ã€‚

```diff sh
--- sample4.sh	2025-02-22 17:56:11.712872214 +0900
@@ -1,4 +1,4 @@
-cat >sample4.h <<EOF
+cat >sample5.h <<EOF
 #pragma once
 class cls_base {
 public:
@@ -20,21 +20,21 @@ public:
     cls_base* create();
 };
 EOF
-cat >sample4.cpp <<EOF
-#include "sample4.h"
+cat >sample5.cpp <<EOF
+#include "sample5.h"
 int main() {
     factory f;
     cls_base* po = f.create();
     return po->method() + po->method2();
 }
 EOF
-cat >sample4_factory.cpp <<EOF
-#include "sample4.h"
+cat >sample5_factory.cpp <<EOF
+#include "sample5.h"
 cls_base* factory::create() {
     static cls_sub2 o;
     return &o;
 }
 EOF
-g++ -c -flto -O3 -g -Wall -pedantic sample4_factory.cpp
-g++ -flto -O3 -g -Wall -pedantic sample4.cpp sample4_factory.o -o sample4
-objdump -M intel -StC sample4
+g++-14 -c -flto -O3 -g -Wall -pedantic sample5_factory.cpp
+g++-14 -flto -O3 -g -Wall -pedantic sample5.cpp sample5_factory.o -o sample5
+objdump -M intel -StC sample5
```

çµæœã¯ä»¥ä¸‹ã®ã¨ãŠã‚Šã€‚

```nasm
...
0000000000001040 <main>:
#include "sample5.h"
int main() {
    1040:	f3 0f 1e fa          	endbr64
    factory f;
    cls_base* po = f.create();
    return po->method() + po->method2();
}
    1044:	b8 09 00 00 00       	mov    eax,0x9
    1049:	c3                   	ret
    104a:	66 0f 1f 44 00 00    	nop    WORD PTR [rax+rax*1+0x0]
...
```

# 3. ã¾ã¨ã‚

- ä»®æƒ³é–¢æ•°å‘¼ã³å‡ºã—ã¯å¿…ãšã‚¤ãƒ³ãƒ©ã‚¤ãƒ³å±•é–‹ã¨ãã®å¾Œã®æœ€é©åŒ–ã‚’é˜»å®³ã™ã‚‹ã‚ã‘ã§ã¯ãªã„